<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>USB Host Custom Class</title>
<title>USB Component: USB Host Custom Class</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber">Version 6.12.4</span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('host_cust_tutorial.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">USB Host Custom Class </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This example application shows how to communicate with serial RS232 adapter with <a href="http://www.prolific.com.tw/us/ShowProduct.aspx?pcid=41&amp;showlevel=0017-0037-0041" class="el" target="_blank">Prolific PL2303</a> UART-to-USB bridge chip from a microcontroller. It is a simple demonstration on how to send data from the USB Host via the USB to serial RS232 adapter to an attached serial terminal. Here, the USB Host sends "Test!" to the USB to serial RS232 adapter and stores all incoming messages from the device in the variable <code>receive_buf</code>. This example is using the Custom Class because the PL2303 is not USB CDC ACM compliant.</p>
<p>The following picture shows an exemplary connection of the development board and an PL2303 based Device. The PL2303 Device is connected to a PC via RS232 to check incoming messages.</p>
<div class="image">
<img src="usbh_cust_pl2303_example_setup.png" alt="usbh_cust_pl2303_example_setup.png"/>
</div>
<h1>Create the "USB Host Custom Class PL2303" Project </h1>
<p>Create a new project in MDK. In this example, we are using the MCBSTM32F400 board with the STM32F407IGHx device. In the <b>Manage Run-Time Environment</b> window, select the following components:</p>
<ul>
<li><b>USB:Host:Custom Class</b></li>
<li><b>Device:STM32Cube Framework (API):Classic</b></li>
<li><b>CMSIS Driver:USB Host (API):Full-speed</b></li>
<li><b>CMSIS Driver:USART (API):PL2303</b></li>
<li><b>Board Support:LED (API):LED</b> (Variant <b>MCBSTM32F400</b>)</li>
</ul>
<p>Click the <b>Resolve</b> button and then <b>OK</b>.</p>
<p>Before continuing to add the required source code, you need to add a template file called <b>USBH_PL2303.c:</b> </p>
<ul>
<li>Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group 'Source Group 1'...</b>.</li>
<li>Click on <b>User Code Template</b> and scroll down on the left side, until you see the <b>USB</b> component with two template files.</li>
<li>Choose <b>USB Host Prolific 2303</b></li>
<li>Click on <b>Add</b>.</li>
</ul>
<p>Finally, your Project should look like this:</p>
<div class="image">
<img src="usbh_cust_example_proj_window.png" alt="usbh_cust_example_proj_window.png"/>
<div class="caption">
USB Host Custom Class PL2303 Project Structure</div></div>
 <h2>Source Files </h2>
<ul>
<li>Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group 'Source Group 1'...</b>.</li>
<li>Click on <b>C File (.c)</b> and enter <b>main</b> in the <b>Name</b> box.</li>
<li>Copy the following code into the main.c file: <pre class="fragment">#include &lt;stdio.h&gt;                      /* Standard I/O .h-file               */
#include &lt;ctype.h&gt;                      /* Character functions                */
#include &lt;string.h&gt;                     /* String and memory functions        */
 
#include "cmsis_os.h"                   /* CMSIS RTOS definitions             */
#include "rl_usb.h"                     /* RL-USB function prototypes         */
 
#include "Board_LED.h"
 
#include "Driver_USART.h"
 
#include "stm32f4xx_hal.h"
 
/* UART Driver */
extern ARM_DRIVER_USART       Driver_USART9;
#define ptrUART_USB         (&amp;Driver_USART9)
 
osThreadId  con_discon_thread_id;
osThreadId  receive_thread_id;
bool        connected;
 
extern uint32_t os_time;
 
uint32_t HAL_GetTick(void) {
  return os_time;
}
 
/* System Clock Configuration */
void SystemClock_Config(void) {
  RCC_OscInitTypeDef RCC_OscInitStruct;
  RCC_ClkInitTypeDef RCC_ClkInitStruct;
 
  /* Enable Power Control clock */
  __PWR_CLK_ENABLE();
 
  /* The voltage scaling allows optimizing the power consumption when the
     device is clocked below the maximum system frequency (see datasheet). */
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);
 
  /* Enable HSE Oscillator and activate PLL with HSE as source */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLM = 25;
  RCC_OscInitStruct.PLL.PLLN = 336;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = 7;
  HAL_RCC_OscConfig(&amp;RCC_OscInitStruct);
 
  /* Select PLL as system clock source and configure the HCLK, PCLK1 and PCLK2
     clocks dividers */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_SYSCLK | RCC_CLOCKTYPE_PCLK1 |
                                RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;
  HAL_RCC_ClockConfig(&amp;RCC_ClkInitStruct, FLASH_LATENCY_5);
}
 
/*------------------------------------------------------------------------------
 *        UART Done Callback
 *----------------------------------------------------------------------------*/
void UART_Done (uint32_t event) {
  switch (event) {
    case ARM_USART_EVENT_SEND_COMPLETE:
      LED_On(1);
      break;
    case ARM_USART_EVENT_RECEIVE_COMPLETE:
      LED_On(2);
      break;
  }
}
 
/*------------------------------------------------------------------------------
 *        USB Host Serial Receive Thread
 *----------------------------------------------------------------------------*/
void USBH_Serial_ReceiveThread (void const *arg) {
  uint8_t receive_buf[64];
  while (1) {
    ptrUART_USB-&gt;Receive (receive_buf, 64);
  }
}
osThreadDef(USBH_Serial_ReceiveThread, osPriorityNormal, 1, NULL);
 
/*------------------------------------------------------------------------------
 *        USB Host Thread
 *----------------------------------------------------------------------------*/
void USBH_Thread (void const *arg) {
  static bool con_last = false;
         bool con;
 
  USBH_Initialize (0);                        /* Initialize USB Host 0        */
 
  while (1) {
    con = (USBH_CustomClass_GetDeviceStatus(0) == usbOK);
    if (con ^ con_last) {
      if (con == true) {
        con_last = true;
        LED_On(0);
        osDelay(1000);
 
        /* Initialize and configure UART &lt;-&gt; USB Bridge */
        ptrUART_USB-&gt;Initialize  (UART_Done);
        ptrUART_USB-&gt;PowerControl(ARM_POWER_FULL);
        ptrUART_USB-&gt;Control     (ARM_USART_MODE_ASYNCHRONOUS |
                                  ARM_USART_DATA_BITS_8       |
                                  ARM_USART_PARITY_NONE       |
                                  ARM_USART_STOP_BITS_1       |
                                  ARM_USART_FLOW_CONTROL_NONE ,
                                  115200                      );
        ptrUART_USB-&gt;Control     (ARM_USART_CONTROL_TX, 1);
        ptrUART_USB-&gt;Control     (ARM_USART_CONTROL_RX, 1);
        ptrUART_USB-&gt;Send        ("Test!\r\n", 7);
        receive_thread_id = osThreadCreate (osThread(USBH_Serial_ReceiveThread), NULL);
      } else {
        con_last = false;
        if (receive_thread_id != 0) {
          osThreadTerminate (receive_thread_id);
          receive_thread_id = 0;
        }
        LED_Off(0);
      }
    } else {
      osDelay(1000);
    }
  }
}
osThreadDef(USBH_Thread, osPriorityNormal, 1, NULL);
 
/*------------------------------------------------------------------------------
 *        Application
 *----------------------------------------------------------------------------*/
int main (void) {
 
  HAL_Init();                                 /* Initialize the HAL Library   */
  SystemClock_Config();                       /* Configure the System Clock   */
  LED_Initialize    ();
 
  receive_thread_id    = 0;
  con_discon_thread_id = osThreadCreate (osThread(USBH_Thread), NULL);
 
  while (1) {
    osDelay(100);
  }
}
</pre></li>
</ul>
<p>Before building the project, you need to edit these configuration files:</p>
<ul>
<li>Double-click <b>Device:RTE_Device.h</b>: enable <b>USB OTG Full-speed</b>, enable <b>Host [Driver_USBH0]</b> and disable <b>Overcurrent Detection Pin</b>.</li>
<li>Double-click <b>USB:USBH_Config_0.c</b> and set <b>USB Host 0:Controller Interface Settings:Custom Host Controller Interface</b><ul>
<li><b>Maximum concurrent Pipes in system</b> to <b>4</b></li>
<li><b>Maximum concurrent Transfers in system</b> to <b>3</b></li>
</ul>
</li>
<li>Double-click <b>CMSIS:RTX_Conf_CM.c</b> and set<ul>
<li><b>Thread Configuration:Number of concurrent running user threads</b> to <b>8</b></li>
<li><b>Thread Configuration:Default Thread stack size</b> to <b>1024</b></li>
<li><b>Thread Configuration:Main Thread stack size</b> to <b>1024</b></li>
<li><b>Thread Configuration:Number of threads with user-provided stack size</b> to <b>4</b></li>
<li><b>Thread Configuration:Total stack size [bytes] for threads with user-provided stack size</b> to <b>2048</b></li>
<li><b>RTX Kernel Timer Tick Configuration:RTOS Kernel Timer input clock frequency [Hz]</b> to <b>168000000</b></li>
</ul>
</li>
</ul>
<p>Before building and downloading the project to the target, make sure that the correct debugger is set in the <b>Options for Target</b> dialog (ALT + F7). You may then build and download the example project to the evaluation board using the µVision commands:</p>
<ul>
<li><b>Project</b> &ndash;&gt; <b> Build target (F7) </b></li>
<li><b>Flash</b> &#160;&#160;&ndash;&gt; <b> Download (F8) </b></li>
<li><b>Debug</b> &ndash;&gt; <b> Start/Stop Debug Session (Ctrl + F5) </b></li>
<li><b>Debug</b> &ndash;&gt; <b> Run (F5) </b></li>
</ul>
<p>After these steps, the project should start executing on your evaluation kit. In case of errors, refer to the Evaluation Board User's Guide for configuration information.</p>
<h1>Using the "USB Host Custom Class PL2303" Project </h1>
<h2>Hardware Setup </h2>
<ul>
<li>Verify all jumper settings on the target hardware.</li>
<li>Connect an USB to serial RS232 adapter using the Prolific PL2303 to the development board's USBFS connector.</li>
<li>Connect the serial line to a PC and open a terminal using 115200 baud data rate.</li>
<li>You should see the message "Test!" in the terminal window. You can also send messages from the PC to the microcontroller device. For that, please check the <code>receive_buf</code> buffer called by the <code>-&gt;Receive</code> function. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="_u_s_b__host.html">USB Host (MDK-Professional only)</a></li><li class="navelem"><a class="el" href="_u_s_b__host__tutorial.html">USB Host Examples</a></li>
    <li class="footer">Generated on Wed Feb 21 2018 20:27:14 for USB Component by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
