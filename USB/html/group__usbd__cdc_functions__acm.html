<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>CDC: Communication Device Class (ACM)</title>
<title>USB Component: CDC: Communication Device Class (ACM)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber">Version 6.12.4</span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__usbd__cdc_functions__acm.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Content</a>  </div>
  <div class="headertitle">
<div class="title">CDC: Communication Device Class (ACM)<div class="ingroups"><a class="el" href="group__usbd___dev_class_functions.html">Device Class</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Implement application specific behavior of a Communication Device Class (CDC) USB Device using the sub-class Abstract Control Model (ACM).  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="groups"></a>
Content</h2></td></tr>
<tr class="memitem:group__usbd__cdc_functions__acm__api"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__cdc_functions__acm__api.html">User API</a></td></tr>
<tr class="memdesc:group__usbd__cdc_functions__acm__api"><td class="mdescLeft">&#160;</td><td class="mdescRight">User API reference of the Communication Device Class (ACM). <br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__usbd__cdc_functions__acm__conf"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__cdc_functions__acm__conf.html">Configuration</a></td></tr>
<tr class="memdesc:group__usbd__cdc_functions__acm__conf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configuration of the USB Device CDC (ACM) Class in ÂµVision. <br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Description</h2>
<p>Implement application specific behavior of a Communication Device Class (CDC) USB Device using the sub-class Abstract Control Model (ACM). </p>
<p>The CDC (ACM) class in the USB Component is used for data communication. You can typically use it in applications that previously used a serial COM or UART communication.</p>
<p>Refer to:</p>
<ul>
<li><a class="el" href="_c_d_c.html">CDC: Communication Device Class</a> for an overview of the CDC class.</li>
<li><a class="el" href="dev_cdc_tutorial.html">USB Device Virtual COM Port</a> example project.</li>
</ul>
<p>The USB Component allows multiple instances of the CDC class. This feature is used to create USB Composite Devices. Each CDC class instance has a separate files and interface functions:</p>
<ul>
<li>A CDC configuration file <a class="el" href="group__usbd__cdc_functions__acm__conf.html">USBD_Config_CDC_n.h</a>.</li>
<li>An application-specific user source code file, which can be implemented with the <script>link_ext('uv4_ca_sourcefiles');</script> <a class="el" href="group__usbd__cdc_functions__acm.html#USBD_User_CDC_ACM_UCT">USBD_User_CDC_ACM_n.c</a>.</li>
<li>Functions that start with the prefix <b>USBD_CDCn_ACM</b> are available for each instance of a CDC ACM class.</li>
</ul>
<p>This documentation uses <em>n</em> as a placeholder for the instance number <em>0</em> - <em>3</em>. Most applications only require one instance of a CDC ACM class. For the first CDC ACM class instance the instance number is 0:</p>
<ul>
<li><b>USBD_Config_CDC_0.h</b></li>
<li><b>USBD_User_CDC_ACM_0.c</b></li>
<li>The function prefix is <b>USBD_CDC0_ACM</b></li>
</ul>
<p><b>Descriptor</b> <b>Requirements</b> </p>
<p>The following descriptors are required in an USB CDC ACM Device:</p>
<ul>
<li>Standard Device Descriptor</li>
<li>Standard Configuration Descriptor</li>
<li>Interface Association Descriptor</li>
<li>CDC Header Functional Descriptor</li>
<li>CDC Union Functional Descriptor</li>
<li>Call Management Functional Descriptor</li>
<li>Abstract Control Management Functional Descriptor</li>
<li>Standard Interface Descriptor for the CDC Class communication interface</li>
<li>Standard Endpoint Descriptor for Interrupt IN endpoint</li>
<li>Standard Interface Descriptor for the CDC Class data interface</li>
<li>Standard Endpoint Descriptors for Bulk IN and Bulk OUT endpoints</li>
</ul>
<p>The necessary descriptors are automatically generated by the USB Middleware Component. The page <a class="el" href="_u_s_b__descriptors.html">USB Descriptors</a> provides more information on the topic.</p>
<p><b>Software Structure</b></p>
<p>The handling for the CDC class endpoint events is implemented in <b>USBD_CDCn_Int_Thread</b> and <b>USBD_CDCn_Bulk_Thread</b> which are started by <a class="el" href="group__usbd__core_functions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca">USBD_Initialize</a>. Each instance of a CDC class runs an instance of <b>USBD_CDCn_Int_Thread</b> and <b>USBD_CDCn_Bulk_Thread</b>.</p>
<p>The thread USBD_CDCn_Int_Thread handles Interrupt IN Endpoint whereas the USBD_CDCn_Bulk_Thread handles the Bulk IN and Bulk OUT Endpoints.</p>
<div align="center">
<img src="msc_inline_mscgraph_3.png" alt="msc_inline_mscgraph_3" border="0" usemap="#msc_inline_mscgraph_3.map"/>
<map name="msc_inline_mscgraph_3.map" id="msc_inline_mscgraph_3.map"><area href="group__usbd__core_functions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca" shape="rect" coords="16,104,105,117" alt=""/>
<area href="group__usbd__core_functions__api.html#gad97153303fc0a6f51c1c20ac050b238f" shape="rect" coords="25,155,96,168" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#ga33a37d63a9085172cff04d458b22f147" shape="rect" coords="16,263,105,276" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#ga33a37d63a9085172cff04d458b22f147" shape="rect" coords="46,276,75,289" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#gaf3ced4ece3f150bb3ce1d2c12babeb95" shape="rect" coords="16,327,105,340" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#gaf3ced4ece3f150bb3ce1d2c12babeb95" shape="rect" coords="37,340,84,353" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#ga5091a4b29df447b17bc6bbe87b17db96" shape="rect" coords="16,359,105,372" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#ga5091a4b29df447b17bc6bbe87b17db96" shape="rect" coords="37,372,84,385" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#ga0d867febbbe62a72bb95c806ece16445" shape="rect" coords="16,410,105,423" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#ga0d867febbbe62a72bb95c806ece16445" shape="rect" coords="25,423,96,436" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#gad73c4ad0493dba23185404855d73af04" shape="rect" coords="16,442,105,455" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#gad73c4ad0493dba23185404855d73af04" shape="rect" coords="40,455,81,468" alt=""/>
<area href="group__usbd__core_functions__api.html#ga9440f139618900f2011034e70cd7a528" shape="rect" coords="16,506,105,519" alt=""/>
<area href="group__usbd__core_functions__api.html#gabefe6dae72a49806a96b981c286d0aeb" shape="rect" coords="16,557,105,570" alt=""/>
<area href="group__usbd__core_functions__api.html#gabefe6dae72a49806a96b981c286d0aeb" shape="rect" coords="52,570,69,583" alt=""/>
</map>
</div>
<h2>Implementation </h2>
<p>To <a class="el" href="_u_s_b__device.html#Creation_Steps">create an USB Device</a> with a CDC ACM class:</p>
<ul>
<li>Set the required number for USB:Device:CDC class instances during the <a class="el" href="_u_s_b__device.html#RTE_Software_Component_Selection">RTE Component Selection</a>.</li>
<li>Set the parameters in the configuration file <a class="el" href="group__usbd__cdc_functions__acm__conf.html">USBD_Config_CDC_n.h</a>.</li>
<li>Implement the application specific behavior using one of the following templates.</li>
</ul>
<p><a class="anchor" id="USBD_User_CDC_ACM_UCT"></a><b>User Code Template USBD_User_CDC_ACM_n.c</b></p>
<p>The following source code contains all the required callback functions and can be used to implement the application specific behavior of a USB CDC (ACM) Device.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2017 ARM Germany GmbH. All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_CDC_ACM_n.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Communication Device Class (CDC)</span></div>
<div class="line"><span class="comment"> *          Abstract Control Model (ACM) User module</span></div>
<div class="line"><span class="comment"> * Rev.:    V6.3.2</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Local Variables</span></div>
<div class="line"><span class="keyword">static</span>   <a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a>        cdc_acm_line_coding = { 0U, 0U, 0U, 0U };</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gae533b6ee1feb71d6210a31f1d83f94e8">USBD_CDCn_ACM_Initialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for initialization</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga54ad02ac3b5e8dbcc40e5fe440076e39">USBD_CDCn_ACM_Uninitialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for de-initialization</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Bus Reset Event.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga3f89d38c6c6bee03e6c3d58c866fe72c">USBD_CDCn_ACM_Reset</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for reset</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to change communication settings.</span></div>
<div class="line"><span class="comment">// \param[in]   line_coding   pointer to CDC_LINE_CODING structure.</span></div>
<div class="line"><span class="comment">// \return      true          set line coding request processed.</span></div>
<div class="line"><span class="comment">// \return      false         set line coding request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaeb540c51afed9b5217086bfde6965e99">USBD_CDCn_ACM_SetLineCoding</a> (<span class="keyword">const</span> <a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a> *line_coding) {</div>
<div class="line">  <span class="comment">// Add code for set line coding</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Store requested settings to local variable</span></div>
<div class="line">  cdc_acm_line_coding = *line_coding;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve communication settings.</span></div>
<div class="line"><span class="comment">// \param[out]  line_coding   pointer to CDC_LINE_CODING structure.</span></div>
<div class="line"><span class="comment">// \return      true          get line coding request processed.</span></div>
<div class="line"><span class="comment">// \return      false         get line coding request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga6c1025b67c21bca8b939f3833acd5349">USBD_CDCn_ACM_GetLineCoding</a> (<a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a> *line_coding) {</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Load settings from ones stored on USBD_CDCn_ACM_SetLineCoding callback</span></div>
<div class="line">  *line_coding = cdc_acm_line_coding;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set control line states.</span></div>
<div class="line"><span class="comment">// \param [in]  state         control line settings bitmap.</span></div>
<div class="line"><span class="comment">//                - bit 0: DTR state</span></div>
<div class="line"><span class="comment">//                - bit 1: RTS state</span></div>
<div class="line"><span class="comment">// \return      true          set control line state request processed.</span></div>
<div class="line"><span class="comment">// \return      false         set control line state request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaf6a0e3a8f8452a4c99d7c379ea533b2b">USBD_CDCn_ACM_SetControlLineState</a> (uint16_t state) {</div>
<div class="line">  <span class="comment">// Add code for set control line state</span></div>
<div class="line"> </div>
<div class="line">  (void)(state);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when new data was received.</span></div>
<div class="line"><span class="comment">// \param [in]  len           number of bytes available for reading.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga0d867febbbe62a72bb95c806ece16445">USBD_CDCn_ACM_DataReceived</a> (uint32_t len) {</div>
<div class="line">  <span class="comment">// Add code for handling new data reception</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when when all data was sent.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga5091a4b29df447b17bc6bbe87b17db96">USBD_CDCn_ACM_DataSent</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for handling new data send</span></div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --><p><a class="anchor" id="USBD_User_CDC_ACM_UART_UCT"></a><b>User Code Template USBD_User_CDC_ACM_UART_n.c</b></p>
<p>The following source code contains all the required callback functions and can be used to implement the application specific behavior of a USB CDC (ACM) Device that can be used as a USB &lt;-&gt; UART bridge.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2017 ARM Germany GmbH. All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_CDC_ACM_UART_n.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Communication Device Class (CDC)</span></div>
<div class="line"><span class="comment"> *          Abstract Control Model (ACM) USB &lt;-&gt; UART Bridge User module</span></div>
<div class="line"><span class="comment"> * Rev.:    V1.0.7</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if defined(RTE_CMSIS_RTOS2)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">  #include &quot;cmsis_os2.h&quot;</span></div>
<div class="line"><span class="preprocessor">#if defined(RTE_CMSIS_RTOS2_RTX5)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">  #include &quot;rtx_os.h&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#if defined(RTE_CMSIS_RTOS)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">  #include &quot;cmsis_os.h&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="preprocessor">#include &quot;Driver_USART.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// UART Configuration ----------------------------------------------------------</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define  UART_PORT              n       // UART Port number</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define  UART_BUFFER_SIZE      (512)    // UART Buffer Size</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define _UART_Driver_(n)        Driver_USART##n</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define  UART_Driver_(n)       _UART_Driver_(n)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">extern</span>   ARM_DRIVER_USART       UART_Driver_(UART_PORT);</div>
<div class="line"><span class="preprocessor">#define  ptrUART              (&amp;UART_Driver_(UART_PORT))</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">// External functions</span></div>
<div class="line"><span class="preprocessor">#ifdef   USB_CMSIS_RTOS</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">extern</span>   <span class="keywordtype">void</span>                   CDCn_ACM_UART_to_USB_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">// Local Variables</span></div>
<div class="line"><span class="keyword">static</span>            uint8_t       uart_rx_buf[UART_BUFFER_SIZE];</div>
<div class="line"><span class="keyword">static</span>            uint8_t       uart_tx_buf[UART_BUFFER_SIZE];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span>   <span class="keyword">volatile</span> int32_t       uart_rx_cnt         =   0;</div>
<div class="line"><span class="keyword">static</span>   <span class="keyword">volatile</span> int32_t       usb_tx_cnt          =   0;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span>   <span class="keywordtype">void</span>                  *cdc_acm_bridge_tid  =   0U;</div>
<div class="line"><span class="keyword">static</span>   <a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a>        cdc_acm_line_coding = { 0U, 0U, 0U, 0U };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when UART has transmitted or received requested number of bytes.</span></div>
<div class="line"><span class="comment">// \param[in]   event         UART event</span></div>
<div class="line"><span class="comment">//               - ARM_USART_EVENT_SEND_COMPLETE:    all requested data was sent</span></div>
<div class="line"><span class="comment">//               - ARM_USART_EVENT_RECEIVE_COMPLETE: all requested data was received</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> UART_Callback (uint32_t event) {</div>
<div class="line">  int32_t cnt;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (event &amp; ARM_USART_EVENT_SEND_COMPLETE) {</div>
<div class="line">    <span class="comment">// USB -&gt; UART</span></div>
<div class="line">    cnt = <a class="code" href="group__usbd__cdc_functions__acm__api.html#gad73c4ad0493dba23185404855d73af04">USBD_CDC_ACM_ReadData</a>(nU, uart_tx_buf, UART_BUFFER_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (cnt &gt; 0) {</div>
<div class="line">      ptrUART-&gt;Send(uart_tx_buf, (uint32_t)(cnt));</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (event &amp; ARM_USART_EVENT_RECEIVE_COMPLETE) {</div>
<div class="line">    <span class="comment">// UART data received, restart new reception</span></div>
<div class="line">    uart_rx_cnt += UART_BUFFER_SIZE;</div>
<div class="line">    ptrUART-&gt;Receive(uart_rx_buf, UART_BUFFER_SIZE);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Thread: Sends data received on UART to USB</span></div>
<div class="line"><span class="comment">// \param[in]     arg           not used.</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> CDCn_ACM_UART_to_USB_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN        <span class="keywordtype">void</span> CDCn_ACM_UART_to_USB_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  int32_t cnt, cnt_to_wrap;</div>
<div class="line"> </div>
<div class="line">  (void)(arg);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    <span class="comment">// UART - &gt; USB</span></div>
<div class="line">    <span class="keywordflow">if</span> (ptrUART-&gt;GetStatus().rx_busy != 0U) {</div>
<div class="line">      cnt  = uart_rx_cnt;</div>
<div class="line">      cnt += ptrUART-&gt;GetRxCount();</div>
<div class="line">      cnt -= usb_tx_cnt;</div>
<div class="line">      <span class="keywordflow">if</span> (cnt &gt;= UART_BUFFER_SIZE) {</div>
<div class="line">        <span class="comment">// Dump data received on UART if USB is not consuming fast enough</span></div>
<div class="line">        usb_tx_cnt += cnt;</div>
<div class="line">        cnt = 0U;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (cnt &gt; 0) {</div>
<div class="line">        cnt_to_wrap = (int32_t)(UART_BUFFER_SIZE - ((uint32_t)usb_tx_cnt &amp; (UART_BUFFER_SIZE - 1)));</div>
<div class="line">        <span class="keywordflow">if</span> (cnt &gt; cnt_to_wrap) {</div>
<div class="line">          cnt = cnt_to_wrap;</div>
<div class="line">        }</div>
<div class="line">        cnt = <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaf3ced4ece3f150bb3ce1d2c12babeb95">USBD_CDC_ACM_WriteData</a>(nU, (uart_rx_buf + ((uint32_t)usb_tx_cnt &amp; (UART_BUFFER_SIZE - 1))), cnt);</div>
<div class="line">        <span class="keywordflow">if</span> (cnt &gt; 0) {</div>
<div class="line">          usb_tx_cnt += cnt;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    osDelay(10U);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> osRtxThread_t        cdcn_acm_uart_to_usb_thread_cb_mem               __SECTION(.bss.os.thread.cb);</div>
<div class="line"><span class="keyword">static</span> uint64_t             cdcn_acm_uart_to_usb_thread_stack_mem[512U / 8U] __SECTION(.bss.os.thread.stack);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t cdcn_acm_uart_to_usb_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;CDCn_ACM_UART_to_USB_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span> &amp;cdcn_acm_uart_to_usb_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;cdcn_acm_uart_to_usb_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">extern</span> <span class="keyword">const</span> osThreadDef_t os_thread_def_CDCn_ACM_UART_to_USB_Thread;</div>
<div class="line">osThreadDef (CDCn_ACM_UART_to_USB_Thread, osPriorityNormal, 1U, 0U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// CDC ACM Callbacks -----------------------------------------------------------</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when new data was received from the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   len           number of bytes available to read.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga0d867febbbe62a72bb95c806ece16445">USBD_CDCn_ACM_DataReceived</a> (uint32_t len) {</div>
<div class="line">  int32_t cnt;</div>
<div class="line"> </div>
<div class="line">  (void)(len);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (ptrUART-&gt;GetStatus().tx_busy == 0U) {</div>
<div class="line">    <span class="comment">// Start USB -&gt; UART</span></div>
<div class="line">    cnt = <a class="code" href="group__usbd__cdc_functions__acm__api.html#gad73c4ad0493dba23185404855d73af04">USBD_CDC_ACM_ReadData</a>(nU, uart_tx_buf, UART_BUFFER_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (cnt &gt; 0) {</div>
<div class="line">      ptrUART-&gt;Send(uart_tx_buf, (uint32_t)(cnt));</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gae533b6ee1feb71d6210a31f1d83f94e8">USBD_CDCn_ACM_Initialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  ptrUART-&gt;Initialize   (UART_Callback);</div>
<div class="line">  ptrUART-&gt;PowerControl (ARM_POWER_FULL);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  cdc_acm_bridge_tid = osThreadNew (CDCn_ACM_UART_to_USB_Thread, NULL, &amp;cdcn_acm_uart_to_usb_thread_attr);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  cdc_acm_bridge_tid = osThreadCreate (osThread (CDCn_ACM_UART_to_USB_Thread), NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga54ad02ac3b5e8dbcc40e5fe440076e39">USBD_CDCn_ACM_Uninitialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (osThreadTerminate (cdc_acm_bridge_tid) == osOK) {</div>
<div class="line">    cdc_acm_bridge_tid = NULL;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  ptrUART-&gt;Control      (ARM_USART_ABORT_RECEIVE, 0U);</div>
<div class="line">  ptrUART-&gt;PowerControl (ARM_POWER_OFF);</div>
<div class="line">  ptrUART-&gt;Uninitialize ();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Bus Reset Event.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga3f89d38c6c6bee03e6c3d58c866fe72c">USBD_CDCn_ACM_Reset</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  ptrUART-&gt;Control      (ARM_USART_ABORT_SEND,    0U);</div>
<div class="line">  ptrUART-&gt;Control      (ARM_USART_ABORT_RECEIVE, 0U);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to change communication settings.</span></div>
<div class="line"><span class="comment">// \param[in]   line_coding   pointer to CDC_LINE_CODING structure.</span></div>
<div class="line"><span class="comment">// \return      true          set line coding request processed.</span></div>
<div class="line"><span class="comment">// \return      false         set line coding request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaeb540c51afed9b5217086bfde6965e99">USBD_CDCn_ACM_SetLineCoding</a> (<span class="keyword">const</span> <a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a> *line_coding) {</div>
<div class="line">  uint32_t data_bits = 0U, parity = 0U, stop_bits = 0U;</div>
<div class="line">  int32_t  status;</div>
<div class="line"> </div>
<div class="line">  ptrUART-&gt;Control (ARM_USART_ABORT_SEND,    0U);</div>
<div class="line">  ptrUART-&gt;Control (ARM_USART_ABORT_RECEIVE, 0U);</div>
<div class="line">  ptrUART-&gt;Control (ARM_USART_CONTROL_TX,    0U);</div>
<div class="line">  ptrUART-&gt;Control (ARM_USART_CONTROL_RX,    0U);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (line_coding-&gt;<a class="code" href="group__usbd__structs.html#a4e6a76c7ae7290a2ffd70897ad631106">bCharFormat</a>) {</div>
<div class="line">    <span class="keywordflow">case</span> 0:                             <span class="comment">// 1 Stop bit</span></div>
<div class="line">      stop_bits = ARM_USART_STOP_BITS_1;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 1:                             <span class="comment">// 1.5 Stop bits</span></div>
<div class="line">      stop_bits = ARM_USART_STOP_BITS_1_5;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 2:                             <span class="comment">// 2 Stop bits</span></div>
<div class="line">      stop_bits = ARM_USART_STOP_BITS_2;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (line_coding-&gt;<a class="code" href="group__usbd__structs.html#a1e40296766f03f33f59f679c6fb845cc">bParityType</a>) {</div>
<div class="line">    <span class="keywordflow">case</span> 0:                             <span class="comment">// None</span></div>
<div class="line">      parity = ARM_USART_PARITY_NONE;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 1:                             <span class="comment">// Odd</span></div>
<div class="line">      parity = ARM_USART_PARITY_ODD;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 2:                             <span class="comment">// Even</span></div>
<div class="line">      parity = ARM_USART_PARITY_EVEN;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (line_coding-&gt;<a class="code" href="group__usbd__structs.html#ada9d5ad8631c5f085c3f402102096f59">bDataBits</a>) {</div>
<div class="line">    <span class="keywordflow">case</span> 5:</div>
<div class="line">      data_bits = ARM_USART_DATA_BITS_5;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 6:</div>
<div class="line">      data_bits = ARM_USART_DATA_BITS_6;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 7:</div>
<div class="line">      data_bits = ARM_USART_DATA_BITS_7;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 8:</div>
<div class="line">      data_bits = ARM_USART_DATA_BITS_8;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  status = ptrUART-&gt;Control(ARM_USART_MODE_ASYNCHRONOUS  |</div>
<div class="line">                            data_bits                    |</div>
<div class="line">                            parity                       |</div>
<div class="line">                            stop_bits                    |</div>
<div class="line">                            ARM_USART_FLOW_CONTROL_NONE  ,</div>
<div class="line">                            line_coding-&gt;<a class="code" href="group__usbd__structs.html#a729a933696d5154f550fb297cacecd70">dwDTERate</a>       );</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Store requested settings to local variable</span></div>
<div class="line">  cdc_acm_line_coding = *line_coding;</div>
<div class="line"> </div>
<div class="line">  uart_rx_cnt = 0;</div>
<div class="line">  usb_tx_cnt  = 0;</div>
<div class="line"> </div>
<div class="line">  ptrUART-&gt;Control (ARM_USART_CONTROL_TX, 1U);</div>
<div class="line">  ptrUART-&gt;Control (ARM_USART_CONTROL_RX, 1U);</div>
<div class="line"> </div>
<div class="line">  ptrUART-&gt;Receive (uart_rx_buf, UART_BUFFER_SIZE);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve communication settings.</span></div>
<div class="line"><span class="comment">// \param[out]  line_coding   pointer to CDC_LINE_CODING structure.</span></div>
<div class="line"><span class="comment">// \return      true          get line coding request processed.</span></div>
<div class="line"><span class="comment">// \return      false         get line coding request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga6c1025b67c21bca8b939f3833acd5349">USBD_CDCn_ACM_GetLineCoding</a> (<a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a> *line_coding) {</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Load settings from ones stored on USBD_CDCn_ACM_SetLineCoding callback</span></div>
<div class="line">  *line_coding = cdc_acm_line_coding;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set control line states.</span></div>
<div class="line"><span class="comment">// \param [in]  state         control line settings bitmap.</span></div>
<div class="line"><span class="comment">//                - bit 0: DTR state</span></div>
<div class="line"><span class="comment">//                - bit 1: RTS state</span></div>
<div class="line"><span class="comment">// \return      true          set control line state request processed.</span></div>
<div class="line"><span class="comment">// \return      false         set control line state request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaf6a0e3a8f8452a4c99d7c379ea533b2b">USBD_CDCn_ACM_SetControlLineState</a> (uint16_t state) {</div>
<div class="line">  <span class="comment">// Add code for set control line state</span></div>
<div class="line"> </div>
<div class="line">  (void)(state);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Feb 21 2018 20:27:15 for USB Component by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
