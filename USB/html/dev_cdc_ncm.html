<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Ethernet-over-USB</title>
<title>USB Component: Ethernet-over-USB</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber">Version 6.12.4</span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dev_cdc_ncm.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Ethernet-over-USB </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Ethernet-over-USB example connects a computer via USB to a Cortex-M system that provides an Ethernet interface for network connectivity. The Linux Kernel provides native support for the CDC (NCM) USB Device class. This example shows how to connect a Ubuntu system via USB to an MCB1800 development board.</p>
<p>The following picture shows an exemplary connection of the development board (in this case a <a href="http://www.keil.com/boards2/keil/mcb1800/" class="el" target="_blank">MCB1800</a>) to a host PC.</p>
<div class="image">
<img src="eth_over_usb_example_setup.png" alt="eth_over_usb_example_setup.png"/>
</div>
<h1>Create the "Ethernet-over-USB" Project </h1>
<p>Create a new project in MDK. In this example, we are using the MCB1800 board with the <a href="http://www.keil.com/dd2/nxp/lpc1857/" class="el" target="_blank">NXP LPC1857</a> device. In the <b>Manage Run-Time Environment</b> window, select the following components:</p>
<ul>
<li><b>USB:Device:CDC:1</b></li>
<li><b>CMSIS Driver:USB Device:USB0</b></li>
<li><b>CMSIS Driver:Ethernet MAC (API):Ethernet MAC</b></li>
<li><b>CMSIS Driver:Ethernet PHY (API):DP83848C</b></li>
</ul>
<p>Click the <b>Resolve</b> button and then <b>OK</b>. Your Project should look like this:</p>
<div class="image">
<img src="usb_eth_usb_proj_window.png" alt="usb_eth_usb_proj_window.png"/>
<div class="caption">
Ethernet-over-USB Project Structure</div></div>
 <h2>Source Files </h2>
<ul>
<li>Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group 'Source Group 1'...</b>.</li>
<li>Click on <b>User Code Template</b> and select <b>CMSIS:CMSIS-RTOS "main" function</b>.</li>
<li>Make the following changes to the main.c file:<ul>
<li>In line 7, right-click and select <b>Insert</b> <b>'#include</b> <b>file'</b> and then <b>rl_usb.h</b> </li>
<li>Initialize the USB device right after the <code>osKernelInitialize()</code> function: <pre class="fragment">  USBD_Initialize    (0);               /* USB Device 0 Initialization        */
  USBD_Connect       (0);               /* USB Device 0 Connect               */</pre></li>
<li>After the <code>osKernelStart</code> add this code: <pre class="fragment">  while (!USBD_Configured (0));

  osThreadSetPriority(osThreadGetId(), osPriorityIdle);
  for (;;);                             // Endless Loop</pre></li>
</ul>
</li>
<li>The complete <b>main.c</b> file should look like this: <div class="fragment"><div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * CMSIS-RTOS &#39;main&#39; function template</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define osObjectsPublic                 // define objects in main module</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;osObjects.h&quot;</span>                  <span class="comment">// RTOS object definitions</span></div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span>                     <span class="comment">// Keil.MDK-Pro::USB:CORE</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * main: initialize and start the system</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) {</div>
<div class="line">  osKernelInitialize ();                <span class="comment">// initialize CMSIS-RTOS</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// initialize peripherals here</span></div>
<div class="line">  <a class="code" href="group__usbd__core_functions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca">USBD_Initialize</a>   (0);                <span class="comment">// USB Device 0 Initialization</span></div>
<div class="line">  <a class="code" href="group__usbd__core_functions__api.html#gad97153303fc0a6f51c1c20ac050b238f">USBD_Connect</a>      (0);                <span class="comment">// USB Device 0 Connect</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// create &#39;thread&#39; functions that start executing,</span></div>
<div class="line">  <span class="comment">// example: tid_name = osThreadCreate (osThread(name), NULL);</span></div>
<div class="line"> </div>
<div class="line">  osKernelStart ();                     <span class="comment">// start thread execution </span></div>
<div class="line">  <span class="keywordflow">while</span> (!<a class="code" href="group__usbd__core_functions__api.html#gabcbbc7a70c6050fbaec107968a581487">USBD_Configured</a> (0));</div>
<div class="line"> </div>
<div class="line">  osThreadSetPriority(osThreadGetId(), osPriorityIdle);</div>
<div class="line">  <span class="keywordflow">for</span> (;;);                             <span class="comment">// Endless Loop</span></div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group 'Source Group 1'...</b>.</li>
<li>Click on <b>User Code Template</b> and select the <b>USB Device CDC NCM Ethernet Bridge</b> template.</li>
<li>Click <b>Add</b> to copy the file <b>USBD_User_CDC_NCM_ETH_0.c</b> to the project.</li>
</ul>
<p>Before building the project, you need to edit these configuration files:</p>
<ul>
<li>Under <b>Device</b>, double-click <b>RTE_Device.h</b> and enable<ul>
<li><b>USB0 Controller [Driver_USBD0 and Driver_USBH0]</b></li>
<li><b>USB0 Controller [Driver_USBD0 and Driver_USBH0]:Device [Driver_USBD0]:High-speed</b></li>
<li><b>ENET (Ethernet Interface) [Driver_ETH_MAC0]</b></li>
<li><b>ENET:RMII (Reduced Media Independent Interface)</b></li>
</ul>
</li>
<li>Under <b>USB</b>, double-click <b>USBD_Config_CDC_0.h</b> and set<ul>
<li><b>Communication Class Subclass</b> to <b>Network Control Model (NCM)</b></li>
</ul>
</li>
<li>Under <b>USB</b>, double-click <b>USBD_Config_0.c</b> and enable<ul>
<li><b>USB Device 0:High-speed</b></li>
</ul>
</li>
<li>Under <b>CMSIS</b>, double-click <b>RTX_Conf_CM.c</b> and set<ul>
<li><b>Number of concurrent running user threads</b> to <b>8</b> </li>
<li><b>Default Thread stack size</b> to <b>512</b></li>
<li><b>Main Thread stack size</b> to <b>512</b></li>
<li><b>Number of threads with user-provided stack size</b> to <b>3</b></li>
<li><b>Total stack size [bytes] for threads with user-provided stack size</b> to <b>1536</b></li>
<li><b>RTOS Kernel Timer input clock frequency [Hz]</b> to <b>180000000</b></li>
</ul>
</li>
</ul>
<p>Before building and downloading the project to the target, make sure that the correct debugger is set in the <b>Options for Target</b> dialog (ALT + F7). You may then build and download the example project to the evaluation board using the µVision commands:</p>
<ul>
<li><b>Project</b> &ndash;&gt; <b> Build target (F7) </b></li>
<li><b>Flash</b> &#160;&#160;&ndash;&gt; <b> Download (F8) </b></li>
<li><b>Debug</b> &ndash;&gt; <b> Start/Stop Debug Session (Ctrl + F5) </b></li>
<li><b>Debug</b> &ndash;&gt; <b> Run (F5) </b></li>
</ul>
<p>After these steps, the project should start executing on your evaluation kit. In case of errors, refer to the Evaluation Board User's Guide for configuration information.</p>
<h1>Using the "Ethernet-over-USB" Project </h1>
<h2>Hardware Setup </h2>
<ul>
<li>Verify all jumper settings on the target hardware.</li>
<li>Connect the development board to a host Linux PC (native or in a virtual machine) attaching a Micro-USB cable to the <b>USB0</b> port and using an Ethernet cable to the <b>ETH</b> connector.</li>
<li>Using a virtual machine, you need to connect to the VM:</li>
</ul>
<div class="image">
<img src="vbox_usb_attach.png" alt="vbox_usb_attach.png"/>
<div class="caption">
Attach USB Device to Virtual Machine</div></div>
<ul>
<li>Within the Linux system (here Ubuntu), you should be able to see a wired Ethernet connection (with the MAC address 1E:30:6C:A2:45:5E):</li>
</ul>
<div class="image">
<img src="ubuntu_ncm.png" alt="ubuntu_ncm.png"/>
<div class="caption">
Wired Ethernet Connection using the USB CDC NCM Device</div></div>
 <dl class="section note"><dt>Note</dt><dd>Set the MAC address in the USB CDC configuration file <a class="el" href="group__usbd__cdc_functions__ncm__conf.html">USBD_Config_CDC_0.h</a>.</dd></dl>
<h1>Troubleshooting </h1>
<p>Especially when working with virtual machines, the USB connection is not passed onto the guest system properly. Then it can help to restart the guest. Also, to make Ubuntu use the network adapter that you like, do the following: In Ubuntu's search, enter "network". The <b>Network</b> <b>Connections</b> program will be available in the search results:</p>
<div class="image">
<img src="ubuntu_network_connections.png" alt="ubuntu_network_connections.png"/>
</div>
<p>Double-click to open and then mark the <b>Wired</b> <b>connection</b> <b>1</b> and click <b>Edit:</b> </p>
<div class="image">
<img src="ubuntu_network_connections_wired1.png" alt="ubuntu_network_connections_wired1.png"/>
</div>
<p>Select the MAC address of your Ethernet-over-USB device and press <b>Save</b> and <b>Close:</b> </p>
<div class="image">
<img src="ubuntu_network_connections_wired1_selection.png" alt="ubuntu_network_connections_wired1_selection.png"/>
</div>
<p>This should instruct Ubuntu to use your device for the network connection. Also, try to disconnect any other network adapter from the virtual machine. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="_u_s_b__device.html">USB Device</a></li><li class="navelem"><a class="el" href="_u_s_b__device__tutorial.html">USB Device Examples</a></li>
    <li class="footer">Generated on Wed Feb 21 2018 20:27:14 for USB Component by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
