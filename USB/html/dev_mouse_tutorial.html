<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>USB Mouse</title>
<title>USB Component: USB Mouse</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber">Version 6.12.4</span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dev_mouse_tutorial.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">USB Mouse </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The USB Mouse example application shows how to control the mouse pointer of a host PC with a microcontroller device using USB Device HID.</p>
<p>The following picture shows an exemplary connection of the development board (in this case a <a href="http://www.keil.com/boards2/keil/mcb1800/" class="el" target="_blank">MCB1800</a>) to a host PC. Using the joystick on the development board you can move the mouse pointer on the screen. Pressing the joystick down will issue a left-click action.</p>
<div class="image">
<img src="mouse_dev_example_setup.png" alt="mouse_dev_example_setup.png"/>
</div>
<h1>Create the "USB Mouse" Project </h1>
<p>Create a new project in MDK. In this example, we are using the MCB1800 board with the <a href="http://www.keil.com/dd2/nxp/lpc1857/" class="el" target="_blank">NXP LPC1857</a> device. In the <b>Manage Run-Time Environment</b> window, select the following components:</p>
<ul>
<li><b>USB:Device:HID:1</b></li>
<li><b>Keil::CMSIS Driver:USB Device:USB0</b></li>
<li><b>Board Support:Joystick (API):Joystick</b> (Variant <b>MCB1800</b>)</li>
</ul>
<p>Click the <b>Resolve</b> button and then <b>OK</b>. Your Project should look like this:</p>
<div class="image">
<img src="usb_mouse_example_proj_window.png" alt="usb_mouse_example_proj_window.png"/>
<div class="caption">
USB Mouse Project Structure</div></div>
 <h2>Source Files </h2>
<ul>
<li>Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group 'Source Group 1'...</b>.</li>
<li>Click on <b>User Code Template</b> and select <b>CMSIS:CMSIS-RTOS "main" function</b>.</li>
<li>Make the following changes to the main.c file:<ul>
<li>In line 7, right-click and select <b>Insert</b> <b>'#include</b> <b>file'</b> and then <b>rl_usb.h</b> </li>
<li>Next, right-click and select <b>Insert</b> <b>'#include</b> <b>file'</b> and then <b>Board_Joystick.h</b> </li>
<li>Copy the following variable definitions to the <b>main</b> function (before the <code>osKernelInitialize()</code> function): <pre class="fragment">  uint32_t state, state_ex = 0;
  uint8_t  mouse_in_report[4];
  bool     update;</pre></li>
<li>Initialize the joystick and the USB device right after the <code>osKernelInitialize()</code> function: <pre class="fragment">  Joystick_Initialize();
 
  USBD_Initialize    (0);               /* USB Device 0 Initialization        */
  USBD_Connect       (0);               /* USB Device 0 Connect               */</pre></li>
<li>After the <code>osKernelStart</code> add this while loop: <pre class="fragment">  while (1) {                           /* Loop forever                       */
    state  = Joystick_GetState();
    update = 0;
    mouse_in_report[0] = 0;
    mouse_in_report[1] = 0;
    mouse_in_report[2] = 0;
    mouse_in_report[3] = 0;
 
    if ((state ^ state_ex) &amp; JOYSTICK_CENTER) {
      mouse_in_report[0] = (state &amp; JOYSTICK_CENTER) ? 1 : 0;   /* Left Click */
      update   = 1;
      state_ex = state;
    }
    if (state &amp; JOYSTICK_LEFT  ) { mouse_in_report[1] = (uint8_t)(-4); update = 1; } /* X Left  */
    if (state &amp; JOYSTICK_RIGHT ) { mouse_in_report[1] =            4 ; update = 1; } /* X Right */
    if (state &amp; JOYSTICK_UP    ) { mouse_in_report[2] = (uint8_t)(-4); update = 1; } /* Y Up    */
    if (state &amp; JOYSTICK_DOWN  ) { mouse_in_report[2] =            4 ; update = 1; } /* Y Down  */
 
    if (update) {
      USBD_HID_GetReportTrigger(0, 0, mouse_in_report, 4);
    }
  }</pre></li>
</ul>
</li>
<li>The complete <b>main.c</b> file should look like this: <div class="fragment"><div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * CMSIS-RTOS &#39;main&#39; function template</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define osObjectsPublic                     // define objects in main module</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;osObjects.h&quot;</span>                      <span class="comment">// RTOS object definitions</span></div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span>                     <span class="comment">// Keil.MDK-Pro::USB:CORE</span></div>
<div class="line"><span class="preprocessor">#include &quot;Board_Joystick.h&quot;</span>             <span class="comment">// ::Board Support:Joystick</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * main: initialize and start the system</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) {</div>
<div class="line">  uint32_t state, state_ex = 0;</div>
<div class="line">  uint8_t  mouse_in_report[4];</div>
<div class="line">  <span class="keywordtype">bool</span>     update;</div>
<div class="line">  osKernelInitialize ();                    <span class="comment">// initialize CMSIS-RTOS</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// initialize peripherals here</span></div>
<div class="line">  Joystick_Initialize();</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group__usbd__core_functions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca">USBD_Initialize</a>    (0);               <span class="comment">/* USB Device 0 Initialization        */</span></div>
<div class="line">  <a class="code" href="group__usbd__core_functions__api.html#gad97153303fc0a6f51c1c20ac050b238f">USBD_Connect</a>       (0); </div>
<div class="line">  <span class="comment">// create &#39;thread&#39; functions that start executing,</span></div>
<div class="line">  <span class="comment">// example: tid_name = osThreadCreate (osThread(name), NULL);</span></div>
<div class="line"></div>
<div class="line">  osKernelStart ();                         <span class="comment">// start thread execution </span></div>
<div class="line">  <span class="keywordflow">while</span> (1) {                           <span class="comment">/* Loop forever                       */</span></div>
<div class="line">    state  = Joystick_GetState();</div>
<div class="line">    update = 0;</div>
<div class="line">    mouse_in_report[0] = 0;</div>
<div class="line">    mouse_in_report[1] = 0;</div>
<div class="line">    mouse_in_report[2] = 0;</div>
<div class="line">    mouse_in_report[3] = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((state ^ state_ex) &amp; JOYSTICK_CENTER) {</div>
<div class="line">      mouse_in_report[0] = (state &amp; JOYSTICK_CENTER) ? 1 : 0;   <span class="comment">/* Left Click */</span></div>
<div class="line">      update   = 1;</div>
<div class="line">      state_ex = state;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (state &amp; JOYSTICK_LEFT  ) { mouse_in_report[1] = (uint8_t)(-4); update = 1; } <span class="comment">/* X Left  */</span></div>
<div class="line">    <span class="keywordflow">if</span> (state &amp; JOYSTICK_RIGHT ) { mouse_in_report[1] =            4 ; update = 1; } <span class="comment">/* X Right */</span></div>
<div class="line">    <span class="keywordflow">if</span> (state &amp; JOYSTICK_UP    ) { mouse_in_report[2] = (uint8_t)(-4); update = 1; } <span class="comment">/* Y Up    */</span></div>
<div class="line">    <span class="keywordflow">if</span> (state &amp; JOYSTICK_DOWN  ) { mouse_in_report[2] =            4 ; update = 1; } <span class="comment">/* Y Down  */</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (update) {</div>
<div class="line">      <a class="code" href="group__usbd__hid_functions__api.html#gad7e97151e60e0b12b3f331610f31c071">USBD_HID_GetReportTrigger</a>(0, 0, mouse_in_report, 4);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group 'Source Group 1'...</b>.</li>
<li>Click on <b>User Code Template</b> and select the <b>USB Device HID Mouse</b> template.</li>
<li>Click <b>Add</b> to copy the file <b>USBD_User_HID_Mouse_0.c</b> to the project.</li>
</ul>
<p>Before building the project, you need to edit these configuration files:</p>
<ul>
<li>Under <b>Device</b>, double-click <b>RTE_Device.h</b> and enable<ul>
<li><b>USB0 Controller [Driver_USBD0 and Driver_USBH0]</b></li>
<li><b>I2C0 (Inter-integrated Circuit Interface 0) [Driver_I2C0]</b> (for the Joystick connected to I2C0)</li>
</ul>
</li>
<li>Under <b>USB</b>, double-click <b>USBD_Config_HID_0.h</b> and enable<ul>
<li><b>Use User Provided HID Report Descriptor</b> and set</li>
<li><b>User Provided HID Report Descriptor Size</b> to <b>52</b></li>
<li>Set the <b>Maximum Input Report Size (in bytes)</b> to <b>4</b> as this is the size of report that is sent for a mouse position change and button presses from the main function.</li>
</ul>
</li>
<li>Under <b>CMSIS</b>, double-click <b>RTX_Conf_CM.c</b> and set<ul>
<li><b>Default Thread stack size</b> to <b>512</b></li>
<li><b>Main Thread stack size</b> to <b>512</b></li>
<li><b>Number of threads with user-provided stack size</b> to <b>4</b></li>
<li><b>Total stack size [bytes] for threads with user-provided stack size</b> to <b>2048</b></li>
<li><b>RTOS Kernel Timer input clock frequency [Hz]</b> to <b>180000000</b></li>
</ul>
</li>
</ul>
<p>Before building and downloading the project to the target, make sure that the correct debugger is set in the <b>Options for Target</b> dialog (ALT + F7). You may then build and download the example project to the evaluation board using the µVision commands:</p>
<ul>
<li><b>Project</b> &ndash;&gt; <b> Build target (F7) </b></li>
<li><b>Flash</b> &#160;&#160;&ndash;&gt; <b> Download (F8) </b></li>
<li><b>Debug</b> &ndash;&gt; <b> Start/Stop Debug Session (Ctrl + F5) </b></li>
<li><b>Debug</b> &ndash;&gt; <b> Run (F5) </b></li>
</ul>
<p>After these steps, the project should start executing on your evaluation kit. In case of errors, refer to the Evaluation Board User's Guide for configuration information.</p>
<h1>Using the "USB Mouse" Project </h1>
<h2>Hardware Setup </h2>
<ul>
<li>Verify all jumper settings on the target hardware.</li>
<li>Connect the development board to a host PC attaching a Micro-USB cable to the <b>USB0</b> port. Observe how it is recognized as a USB HID device with the mouse protocol:</li>
</ul>
<div class="image">
<img src="hid_compliant_mouse.png" alt="hid_compliant_mouse.png"/>
</div>
<ul>
<li>Play around with the joystick and see how the mouse moves on the screen. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="_u_s_b__device.html">USB Device</a></li><li class="navelem"><a class="el" href="_u_s_b__device__tutorial.html">USB Device Examples</a></li>
    <li class="footer">Generated on Wed Feb 21 2018 20:27:14 for USB Component by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
